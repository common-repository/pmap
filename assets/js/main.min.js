(function(a){a(document).ready(function(){var c=Backbone.Model.extend({defaults:{address:"",formatted_address:"",pos:new google.maps.LatLng(44.643254,33.517699),marker:{},map:{},geocoder:new google.maps.Geocoder(),map_options:{zoom:8,center:new google.maps.LatLng(44.643254,33.517699),}},initialize:function(){this.bind("change:map_options",this.regenmap,this);this.bind("change:map",this.regenmarker,this);this.bind("change:address",this.geocodeaddress,this);this.bind("change:pos",this.setpositionvalues,this);this.bind("change:formatted_address",this.changeformatted_address,this)},setpositionvalues:function(){var d=this.get("pos");this.view.latitude.value=d.lat();this.view.longitude.value=d.lng();this.get("map").setCenter(d)},changeformatted_address:function(){var d=this.get("formatted_address");this.view.msgblock.innerHTML=d},regenmap:function(){var e=this;var f=this.get("map_options");var d=new google.maps.Map(e.view.mapblock,f);this.set({map:d})},regenmarker:function(){var f=this;var e={position:f.get("pos"),map:f.get("map"),draggable:true,animation:google.maps.Animation.DROP,};e.title=(this.get("formatted_address")!="")?this.get("formatted_address"):"marker title";var d=new google.maps.Marker(e);this.set({marker:d});google.maps.event.addListener(d,"dragend",function(){f.geocodeposition(d.getPosition())})},geocodeposition:function(h){var f=this;var e=new google.maps.Geocoder();var d=this.get("map");e.geocode({latLng:h},function(i,g){if(g==google.maps.GeocoderStatus.OK){d.setCenter(i[0].geometry.location);f.set({formatted_address:i[0].formatted_address,pos:i[0].geometry.location,pos:i[0].geometry.location})}else{f.set({formatted_address:"error to geocode this address"})}})},geocodeaddress:function(){var i=this;var f=this.get("address");var h=this.get("geocoder");var d=this.get("map");var e=this.get("marker");h.geocode({address:f},function(j,g){if(g==google.maps.GeocoderStatus.OK){i.view.msgblock.innerHTML=j[0].formatted_address;i.set({pos:j[0].geometry.location});e.setPosition(j[0].geometry.location)}else{i.view.msgblock.innerHTML="error to geocode this address"}})},});var b=Backbone.View.extend({el:document.getElementById("pmieldswrap"),mapblock:document.getElementById("pmmap"),msgblock:document.getElementById("pmmsg"),latitude:document.getElementById("pmmap_latitude"),longitude:document.getElementById("pmmap_longitude"),events:{"click #pm_setaddress":"pm_setaddress",},initialize:function(){var d=this;if(!this.el){alert("not find #pmieldswrap block");return}if(!google){alert("not load goole map");return}this.model=new c();this.model.view=this;this.init();this.bind("change:address",this.address_keyup,this);this.bind("change:latlng",this.pm_setLatLng,this);document.getElementById("pm_address").onkeyup=function(){d.trigger("change:address")};a(".pmLatLng").keyup(function(){d.trigger("change:latlng")})},pm_setaddress:function(){this.trigger("change:address")},pm_setLatLng:function(){var f=this.latitude.value;var d=this.longitude.value;var e=new google.maps.LatLng(f,d);this.model.set({pos:e})},init:function(){var g=this;var f=[];var e=this.latitude.value;var i=this.longitude.value;if(e!==undefined&&e!==""){f[0]=e}if(i!==undefined&&i!==""){f[1]=i}var h={};if(f.length==2){h.center=new google.maps.LatLng(f[0],f[1])}var d=_.extend(g.model.get("map_options"),h);this.model.set({map_options:d,pos:d.center},{silent:true});this.model.trigger("change:map_options");this.model.trigger("change:address")},address_keyup:function(){var d=document.getElementById("pm_address").value;this.model.set({address:d})},});new b()})})(jQuery);